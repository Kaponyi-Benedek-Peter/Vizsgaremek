import{b,g as _,q as R}from"./chunk-SISV7ZTJ.js";import{J as d,N as c,Nb as h,R as S,S as v,h as m,ja as g,l as E,y as a}from"./chunk-F6XLXXZ5.js";var p=class o{toasts=g([]);toasts$=this.toasts.asReadonly();show(e,t="info",s=3e3){let r=Math.random().toString(36).substring(7),i={id:r,message:e,type:t,duration:s};this.toasts.update(l=>[...l,i]),s>0&&setTimeout(()=>{this.remove(r)},s)}success(e,t){this.show(e,"success",t)}error(e,t){this.show(e,"error",t)}info(e,t){this.show(e,"info",t)}warning(e,t){this.show(e,"warning",t)}remove(e){this.toasts.update(t=>t.filter(s=>s.id!==e))}clear(){this.toasts.set([])}static \u0275fac=function(t){return new(t||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var f=class o{constructor(e,t){this.http=e;this.router=t;this.initAuth(),this.setupStorageListener()}API_URL=R.baseURL;TOKEN_KEY="auth_token";USER_KEY="auth_user";EXPIRES_KEY="auth_expires";STORAGE_TYPE_KEY="auth_storage_type";SESSION_TOKEN_KEY="auth_session_token";toastService=v(p);authStateSignal=g({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null});authState=this.authStateSignal.asReadonly();isAuthenticated=h(()=>this.authStateSignal().isAuthenticated);currentUser=h(()=>this.authStateSignal().user);token=h(()=>this.authStateSignal().token);sessionToken=h(()=>this.authStateSignal().sessionToken);authStateSubject=new m({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null});authState$=this.authStateSubject.asObservable();initAuth(){let e=this.getStoredToken(),t=this.getStoredUser(),s=this.getStoredExpiration(),r=this.getStoredSessionToken();e&&t&&s&&(new Date<s?this.updateAuthState({isAuthenticated:!0,user:t,token:e,sessionToken:r,expiresAt:s}):this.clearStorage())}setupStorageListener(){typeof window<"u"&&window.addEventListener("storage",e=>{e.key===this.TOKEN_KEY&&e.newValue===null&&(this.updateAuthState({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null}),this.router.url.includes("/login")||this.router.navigate(["/login"])),e.key===this.TOKEN_KEY&&e.newValue!==null&&this.initAuth()})}isTokenExpired(){let e=this.authStateSignal().expiresAt;if(!e)return!0;let t=new Date,s=new Date(e),r=300*1e3;return t.getTime()>=s.getTime()-r}loginRequest(e,t){let s={id:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/login_request`,s).pipe(a(this.handleError.bind(this)))}loginPromise(e,t,s){let r={id:e,confirmation_token:t};return this.http.post(`${this.API_URL}/api/login_promise`,r).pipe(d(i=>{this.handleLoginSuccess(i,s)}),a(this.handleError.bind(this)))}register(e,t,s,r){let i={email:this.encodeBase64(e),password:this.encodeBase64(t),firstname:this.encodeBase64(s),lastname:this.encodeBase64(r)};return this.http.post(`${this.API_URL}/api/registration_request`,i).pipe(a(this.handleError.bind(this)))}completeRegistration(e,t,s=!0){let r={id:e,token:t};return this.http.post(`${this.API_URL}/api/registration_promise`,r).pipe(d(i=>{this.handleLoginSuccess(i,s,i.user)}),a(this.handleError.bind(this)))}requestPasswordChange(e,t){let s={email:e,password:t};return this.http.post(`${this.API_URL}/api/chpass_request`,s).pipe(a(this.handleError.bind(this)))}completePasswordChange(e,t){let s={id:e,token:t};return this.http.post(`${this.API_URL}/api/chpass_promise`,s).pipe(a(this.handleError.bind(this)))}logout(){this.clearStorage(),this.updateAuthState({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null}),this.router.navigate(["/login"])}getToken(){let e=this.authStateSignal().token;return e&&this.isTokenExpired()?(this.logout(),null):e}getSessionToken(){return this.authStateSignal().sessionToken}isUserAuthenticated(){let e=this.authStateSignal().isAuthenticated,t=this.getToken()!==null;return e&&t}refreshAuthState(){this.initAuth()}hasStoredSession(){return this.getStoredToken()!==null}decodeJWT(e){try{let s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(s).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return console.error("JWT decode error:",t),null}}handleLoginSuccess(e,t,s){let r=e.jwt_token,i=e.session_token??null,l=e.jwt_token_expiration?new Date(e.jwt_token_expiration):new Date(Date.now()+10080*60*1e3),u=s;if(!u&&r){let n=this.decodeJWT(r);n&&(u={id:n.sub||n["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"],email:n.email||n["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"],firstname:n.firstname||"",lastname:n.lastname||""})}this.clearStorage(),this.storeToken(r,l,t),this.storeSessionToken(i,t),u&&this.storeUser(u,t),this.updateAuthState({isAuthenticated:!0,user:u||this.getStoredUser(),token:r,sessionToken:i,expiresAt:l}),this.router.navigate(["/home"]),setTimeout(()=>{this.toastService.success("auth.success.welcome_back")},300)}updateAuthState(e){this.authStateSignal.set(e),this.authStateSubject.next(e)}storeToken(e,t,s){let r=s?localStorage:sessionStorage;r.setItem(this.TOKEN_KEY,e),r.setItem(this.EXPIRES_KEY,t.toISOString()),r.setItem(this.STORAGE_TYPE_KEY,s?"local":"session")}storeSessionToken(e,t){if(!e)return;(t?localStorage:sessionStorage).setItem(this.SESSION_TOKEN_KEY,e)}storeUser(e,t){(t?localStorage:sessionStorage).setItem(this.USER_KEY,JSON.stringify(e))}getStoredToken(){return localStorage.getItem(this.TOKEN_KEY)||sessionStorage.getItem(this.TOKEN_KEY)}getStoredSessionToken(){return localStorage.getItem(this.SESSION_TOKEN_KEY)||sessionStorage.getItem(this.SESSION_TOKEN_KEY)}getStoredUser(){let e=localStorage.getItem(this.USER_KEY)||sessionStorage.getItem(this.USER_KEY);if(!e)return null;try{return JSON.parse(e)}catch{return null}}getStoredExpiration(){let e=localStorage.getItem(this.EXPIRES_KEY)||sessionStorage.getItem(this.EXPIRES_KEY);if(!e)return null;try{return new Date(e)}catch{return null}}clearStorage(){[localStorage,sessionStorage].forEach(e=>{e.removeItem(this.TOKEN_KEY),e.removeItem(this.USER_KEY),e.removeItem(this.EXPIRES_KEY),e.removeItem(this.STORAGE_TYPE_KEY),e.removeItem(this.SESSION_TOKEN_KEY)})}encodeBase64(e){try{return btoa(unescape(encodeURIComponent(e)))}catch{return btoa(e)}}handleError(e){let t="An unknown error occurred";if(e.error instanceof ErrorEvent)t=`Error: ${e.error.message}`;else{let s=e.error;switch(e.status){case 400:t="auth.errors.bad_request";break;case 401:s?.error==="hianyzo_auth_header"?t="auth.errors.missing_auth_header":s?.error==="hibas_token"?(t="auth.errors.invalid_token",this.logout()):t="auth.errors.invalid_credentials";break;case 404:t="auth.errors.not_found";break;case 409:t="auth.errors.email_exists";break;case 500:t="auth.errors.server_error";break;default:t=s?.message||s?.error||t}}return E(()=>new Error(t))}static \u0275fac=function(t){return new(t||o)(S(b),S(_))};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a,f as b};
