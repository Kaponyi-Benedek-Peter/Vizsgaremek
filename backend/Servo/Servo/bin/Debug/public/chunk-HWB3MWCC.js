import{b as _,g as f,q as R}from"./chunk-CWU6Z7Q4.js";import{J as d,N as c,Nb as h,R as S,S as b,h as E,ja as g,l as v,y as a}from"./chunk-F6XLXXZ5.js";var p=class o{toasts=g([]);toasts$=this.toasts.asReadonly();show(e,t="info",s=3e3){let i=Math.random().toString(36).substring(7),r={id:i,message:e,type:t,duration:s};this.toasts.update(l=>[...l,r]),s>0&&setTimeout(()=>{this.remove(i)},s)}success(e,t){this.show(e,"success",t)}error(e,t){this.show(e,"error",t)}info(e,t){this.show(e,"info",t)}warning(e,t){this.show(e,"warning",t)}remove(e){this.toasts.update(t=>t.filter(s=>s.id!==e))}clear(){this.toasts.set([])}static \u0275fac=function(t){return new(t||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var k=class o{constructor(e,t){this.http=e;this.router=t;this.initAuth(),this.setupStorageListener()}API_URL=R.baseURL;TOKEN_KEY="auth_token";USER_KEY="auth_user";EXPIRES_KEY="auth_expires";STORAGE_TYPE_KEY="auth_storage_type";SESSION_TOKEN_KEY="auth_session_token";toastService=b(p);authStateSignal=g({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null});authState=this.authStateSignal.asReadonly();isAuthenticated=h(()=>this.authStateSignal().isAuthenticated);currentUser=h(()=>this.authStateSignal().user);token=h(()=>this.authStateSignal().token);sessionToken=h(()=>this.authStateSignal().sessionToken);authStateSubject=new E({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null});authState$=this.authStateSubject.asObservable();initAuth(){let e=this.getStoredToken(),t=this.getStoredUser(),s=this.getStoredExpiration(),i=this.getStoredSessionToken();e&&t&&s&&(new Date<s?this.updateAuthState({isAuthenticated:!0,user:t,token:e,sessionToken:i,expiresAt:s}):this.clearStorage())}setupStorageListener(){typeof window<"u"&&window.addEventListener("storage",e=>{e.key===this.TOKEN_KEY&&e.newValue===null&&(this.updateAuthState({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null}),this.router.url.includes("/login")||this.router.navigate(["/login"])),e.key===this.TOKEN_KEY&&e.newValue!==null&&this.initAuth()})}isTokenExpired(){let e=this.authStateSignal().expiresAt;if(!e)return!0;let t=new Date,s=new Date(e),i=300*1e3;return t.getTime()>=s.getTime()-i}loginRequest(e,t){let s={email:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/login_request`,s).pipe(a(this.handleError.bind(this)))}loginPromise(e,t,s){let i={id:e,confirmation_token:t};return this.http.post(`${this.API_URL}/api/login_promise`,i).pipe(d(r=>{this.handleLoginSuccess(r,s)}),a(this.handleError.bind(this)))}register(e,t,s,i){let r={email:this.encodeBase64(e),password:this.encodeBase64(t),firstname:this.encodeBase64(s),lastname:this.encodeBase64(i)};return this.http.post(`${this.API_URL}/api/registration_request`,r).pipe(a(this.handleError.bind(this)))}completeRegistration(e,t,s=!0){let i={id:e,token:t};return this.http.post(`${this.API_URL}/api/registration_promise`,i).pipe(d(r=>{this.handleLoginSuccess(r,s,r.user,!0)}),a(this.handleError.bind(this)))}requestPasswordChange(e,t){let s={email:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/chpass_request`,s).pipe(a(this.handleError.bind(this)))}completePasswordChange(e,t){let s={id:this.encodeBase64(e),token:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/chpass_promise`,s).pipe(a(this.handleError.bind(this)))}logout(){this.clearStorage(),this.updateAuthState({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null}),this.router.navigate(["/login"])}getToken(){let e=this.authStateSignal().token;return e&&this.isTokenExpired()?(this.logout(),null):e}getSessionToken(){return this.authStateSignal().sessionToken}isUserAuthenticated(){let e=this.authStateSignal().isAuthenticated,t=this.getToken()!==null;return e&&t}refreshAuthState(){this.initAuth()}hasStoredSession(){return this.getStoredToken()!==null}decodeJWT(e){try{let s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(s).split("").map(r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(i)}catch(t){return console.error("JWT decode error:",t),null}}handleLoginSuccess(e,t,s,i=!1){let r=e.jwt_token,l=e.session_token??null,m=e.jwt_token_expiration?new Date(e.jwt_token_expiration):new Date(Date.now()+10080*60*1e3),u=s;if(!u&&r){let n=this.decodeJWT(r);n&&(u={id:n.sub||n["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"],email:n.email||n["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"],firstname:n.firstname||"",lastname:n.lastname||""}),i||(this.router.navigate(["/home"]),setTimeout(()=>{this.toastService.success("auth.success.welcome_back")},300))}this.clearStorage(),this.storeToken(r,m,t),this.storeSessionToken(l,t),u&&this.storeUser(u,t),this.updateAuthState({isAuthenticated:!0,user:u||this.getStoredUser(),token:r,sessionToken:l,expiresAt:m}),this.router.navigate(["/home"]),setTimeout(()=>{this.toastService.success("auth.success.welcome_back")},300)}updateAuthState(e){this.authStateSignal.set(e),this.authStateSubject.next(e)}storeToken(e,t,s){let i=s?localStorage:sessionStorage;i.setItem(this.TOKEN_KEY,e),i.setItem(this.EXPIRES_KEY,t.toISOString()),i.setItem(this.STORAGE_TYPE_KEY,s?"local":"session")}storeSessionToken(e,t){if(!e)return;(t?localStorage:sessionStorage).setItem(this.SESSION_TOKEN_KEY,e)}storeUser(e,t){(t?localStorage:sessionStorage).setItem(this.USER_KEY,JSON.stringify(e))}getStoredToken(){return localStorage.getItem(this.TOKEN_KEY)||sessionStorage.getItem(this.TOKEN_KEY)}getStoredSessionToken(){return localStorage.getItem(this.SESSION_TOKEN_KEY)||sessionStorage.getItem(this.SESSION_TOKEN_KEY)}getStoredUser(){let e=localStorage.getItem(this.USER_KEY)||sessionStorage.getItem(this.USER_KEY);if(!e)return null;try{return JSON.parse(e)}catch{return null}}getStoredExpiration(){let e=localStorage.getItem(this.EXPIRES_KEY)||sessionStorage.getItem(this.EXPIRES_KEY);if(!e)return null;try{return new Date(e)}catch{return null}}clearStorage(){[localStorage,sessionStorage].forEach(e=>{e.removeItem(this.TOKEN_KEY),e.removeItem(this.USER_KEY),e.removeItem(this.EXPIRES_KEY),e.removeItem(this.STORAGE_TYPE_KEY),e.removeItem(this.SESSION_TOKEN_KEY)})}encodeBase64(e){try{return btoa(unescape(encodeURIComponent(e)))}catch{return btoa(e)}}handleError(e){let t="An unknown error occurred";if(e.error instanceof ErrorEvent)t=`Error: ${e.error.message}`;else{let s=e.error;switch(e.status){case 400:t="auth.errors.bad_request";break;case 401:s?.error==="hianyzo_auth_header"?t="auth.errors.missing_auth_header":s?.error==="hibas_token"?(t="auth.errors.invalid_token",this.logout()):t="auth.errors.invalid_credentials";break;case 404:t="auth.errors.not_found";break;case 409:t="auth.errors.email_exists";break;case 500:t="auth.errors.server_error";break;default:t=s?.message||s?.error||t}}return v(()=>new Error(t))}static \u0275fac=function(t){return new(t||o)(S(_),S(f))};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a,k as b};
