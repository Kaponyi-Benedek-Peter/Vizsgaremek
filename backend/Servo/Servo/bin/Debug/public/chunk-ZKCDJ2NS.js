import{b,g as E,q as R}from"./chunk-DXTRCEFC.js";import{J as d,Mb as c,N as h,R as g,S as v,h as m,ja as l,l as S,y as u}from"./chunk-33H2QBHE.js";var p=class o{toasts=l([]);toasts$=this.toasts.asReadonly();show(e,t="info",s=3e3){let r=Math.random().toString(36).substring(7),i={id:r,message:e,type:t,duration:s};this.toasts.update(n=>[...n,i]),s>0&&setTimeout(()=>{this.remove(r)},s)}success(e,t){this.show(e,"success",t)}error(e,t){this.show(e,"error",t)}info(e,t){this.show(e,"info",t)}warning(e,t){this.show(e,"warning",t)}remove(e){this.toasts.update(t=>t.filter(s=>s.id!==e))}clear(){this.toasts.set([])}static \u0275fac=function(t){return new(t||o)};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})};var f=class o{constructor(e,t){this.http=e;this.router=t;this.initAuth(),this.setupStorageListener()}API_URL=R.baseURL;TOKEN_KEY="auth_token";USER_KEY="auth_user";EXPIRES_KEY="auth_expires";STORAGE_TYPE_KEY="auth_storage_type";toastService=v(p);authStateSignal=l({isAuthenticated:!1,user:null,token:null,expiresAt:null});authState=this.authStateSignal.asReadonly();isAuthenticated=c(()=>this.authStateSignal().isAuthenticated);currentUser=c(()=>this.authStateSignal().user);token=c(()=>this.authStateSignal().token);authStateSubject=new m({isAuthenticated:!1,user:null,token:null,expiresAt:null});authState$=this.authStateSubject.asObservable();initAuth(){let e=this.getStoredToken(),t=this.getStoredUser(),s=this.getStoredExpiration();e&&t&&s&&(new Date<s?this.updateAuthState({isAuthenticated:!0,user:t,token:e,expiresAt:s}):this.clearStorage())}setupStorageListener(){typeof window<"u"&&window.addEventListener("storage",e=>{e.key===this.TOKEN_KEY&&e.newValue===null&&(this.updateAuthState({isAuthenticated:!1,user:null,token:null,expiresAt:null}),this.router.url.includes("/login")||this.router.navigate(["/login"])),e.key===this.TOKEN_KEY&&e.newValue!==null&&this.initAuth()})}isTokenExpired(){let e=this.authStateSignal().expiresAt;if(!e)return!0;let t=new Date,s=new Date(e),r=300*1e3;return t.getTime()>=s.getTime()-r}loginRequest(e,t){let s={id:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/login_request`,s).pipe(u(this.handleError.bind(this)))}loginPromise(e,t,s){let r={id:this.encodeBase64(e),confirmation_token:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/login_promise`,r).pipe(d(i=>{this.handleLoginSuccess(i,s)}),u(this.handleError.bind(this)))}register(e,t,s,r){let i={email:this.encodeBase64(e),password:this.encodeBase64(t),firstname:this.encodeBase64(s),lastname:this.encodeBase64(r)};return this.http.post(`${this.API_URL}/api/registration_request`,i).pipe(u(this.handleError.bind(this)))}completeRegistration(e,t,s=!0){let r={id:e,token:t};return this.http.post(`${this.API_URL}/api/registration_promise`,r).pipe(d(i=>{this.handleLoginSuccess(i,s,i.user)}),u(this.handleError.bind(this)))}requestPasswordChange(e,t){let s={email:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/chpass_request`,s).pipe(u(this.handleError.bind(this)))}completePasswordChange(e,t){let s={id:e,token:t};return this.http.post(`${this.API_URL}/api/chpass_promise`,s).pipe(u(this.handleError.bind(this)))}logout(){this.clearStorage(),this.updateAuthState({isAuthenticated:!1,user:null,token:null,expiresAt:null}),this.router.navigate(["/login"])}getToken(){let e=this.authStateSignal().token;return e&&this.isTokenExpired()?(this.logout(),null):e}isUserAuthenticated(){let e=this.authStateSignal().isAuthenticated,t=this.getToken()!==null;return e&&t}refreshAuthState(){this.initAuth()}hasStoredSession(){return this.getStoredToken()!==null}decodeJWT(e){try{let s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(s).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return console.error("Error decoding JWT:",t),null}}handleLoginSuccess(e,t,s){let r=e.jwt_token,i=e.jwt_token_expiration?new Date(e.jwt_token_expiration):new Date(Date.now()+10080*60*1e3),n=s;if(!n&&r){let a=this.decodeJWT(r);a&&(n={id:a.sub||a["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"],email:a.email||a["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"],firstname:a.firstname||"",lastname:a.lastname||""})}this.clearStorage(),this.storeToken(r,i,t),n&&this.storeUser(n,t),this.updateAuthState({isAuthenticated:!0,user:n||this.getStoredUser(),token:r,expiresAt:i}),this.router.navigate(["/home"]),setTimeout(()=>{this.toastService.success("auth.success.welcome_back")},300)}updateAuthState(e){this.authStateSignal.set(e),this.authStateSubject.next(e)}storeToken(e,t,s){let r=s?localStorage:sessionStorage;r.setItem(this.TOKEN_KEY,e),r.setItem(this.EXPIRES_KEY,t.toISOString()),r.setItem(this.STORAGE_TYPE_KEY,s?"local":"session")}storeUser(e,t){(t?localStorage:sessionStorage).setItem(this.USER_KEY,JSON.stringify(e))}getStoredToken(){return localStorage.getItem(this.TOKEN_KEY)||sessionStorage.getItem(this.TOKEN_KEY)}getStoredUser(){let e=localStorage.getItem(this.USER_KEY)||sessionStorage.getItem(this.USER_KEY);if(!e)return null;try{return JSON.parse(e)}catch{return null}}getStoredExpiration(){let e=localStorage.getItem(this.EXPIRES_KEY)||sessionStorage.getItem(this.EXPIRES_KEY);if(!e)return null;try{return new Date(e)}catch{return null}}clearStorage(){[localStorage,sessionStorage].forEach(e=>{e.removeItem(this.TOKEN_KEY),e.removeItem(this.USER_KEY),e.removeItem(this.EXPIRES_KEY),e.removeItem(this.STORAGE_TYPE_KEY)})}encodeBase64(e){try{return btoa(unescape(encodeURIComponent(e)))}catch(t){return console.error("Base64 encoding error:",t),btoa(e)}}decodeBase64(e){try{return decodeURIComponent(escape(atob(e)))}catch(t){return console.error("Base64 decoding error:",t),atob(e)}}handleError(e){let t="An unknown error occurred";if(e.error instanceof ErrorEvent)t=`Error: ${e.error.message}`;else{let s=e.error;switch(e.status){case 400:t="auth.errors.bad_request";break;case 401:s?.error==="hianyzo_auth_header"?t="auth.errors.missing_auth_header":s?.error==="hibas_token"?(t="auth.errors.invalid_token",this.logout()):t="auth.errors.invalid_credentials";break;case 404:t="auth.errors.not_found";break;case 409:t="auth.errors.email_exists";break;case 500:t="auth.errors.server_error";break;default:t=s?.message||s?.error||t}}return S(()=>new Error(t))}static \u0275fac=function(t){return new(t||o)(g(b),g(E))};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a,f as b};
