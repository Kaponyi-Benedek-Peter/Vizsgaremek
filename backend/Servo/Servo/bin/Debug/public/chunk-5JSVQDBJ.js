import{b as I,m as O,q as j}from"./chunk-MXNZA3P6.js";import{K as L,N as h,Ob as c,R as E,S as u,a as d,b as m,c as v,da as M,h as N,ja as o,k as b,l as R,o as P,p as C,q as l,y as p}from"./chunk-766VLGYE.js";var f=class n{constructor(e){this.translate=e;this.initLanguage()}currentLangSubject=new N("en");currentLang$=this.currentLangSubject.asObservable();initLanguage(){let t=["hu","en","de"];this.translate.addLangs(t),this.translate.setDefaultLang("en");let i=this.getSavedLanguage()||"en";this.setLanguage(i)}setLanguage(e){this.translate.use(e),this.currentLangSubject.next(e),this.saveLanguage(e)}getCurrentLanguage(){return this.currentLangSubject.value}saveLanguage(e){localStorage.setItem("preferredLanguage",e)}getSavedLanguage(){return localStorage.getItem("preferredLanguage")}instant(e){return this.translate.instant(e)}static \u0275fac=function(t){return new(t||n)(E(O))};static \u0275prov=h({token:n,factory:n.\u0275fac,providedIn:"root"})};function A(n,e){let r=!e?.manualCleanup?e?.injector?.get(M)??u(M):null,i=V(e?.equal),a;e?.requireSync?a=o({kind:0},{equal:i}):a=o({kind:1,value:e?.initialValue},{equal:i});let s,y=n.subscribe({next:g=>a.set({kind:1,value:g}),error:g=>{a.set({kind:2,error:g}),s?.()},complete:()=>{s?.()}});if(e?.requireSync&&a().kind===0)throw new L(601,!1);return s=r?.onDestroy(y.unsubscribe.bind(y)),c(()=>{let g=a();switch(g.kind){case 1:return g.value;case 2:throw g.error;case 0:throw new L(601,!1)}},{equal:e?.equal})}function V(n=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&n(e.value,t.value)}var D=class n{translationService=u(f);http=u(I);currentLang=A(this.translationService.currentLang$,{initialValue:"en"});ratesSignal=o({USD:.0028,EUR:.0026});currencyMap={hu:{code:"HUF",symbol:"Ft",locale:"hu-HU"},en:{code:"USD",symbol:"$",locale:"en-US"},de:{code:"EUR",symbol:"\u20AC",locale:"de-DE"}};currentCurrency=c(()=>this.currencyMap[this.currentLang()]);constructor(){this.fetchExchangeRates()}fetchExchangeRates(){return v(this,null,function*(){try{let e=yield P(this.http.get("https://api.frankfurter.app/latest?from=HUF&to=USD,EUR"));e?.rates&&(this.ratesSignal.set(e.rates),console.log("Exchange rates updated:",e.rates))}catch(e){console.warn("Failed to fetch exchange rates, using fallback values:",e)}})}convertFromHuf(e,t){if(t==="HUF")return e;let r=this.ratesSignal()[t];return r?Math.round(e*r*100)/100:e}formatPrice(e){let t=this.currentCurrency(),r=e.toLocaleString(t.locale,{minimumFractionDigits:0,maximumFractionDigits:2});return t.code==="HUF"?`${r} ${t.symbol}`:`${t.symbol}${r}`}getBasePrice(e){let t=this.currentCurrency().code,r=parseFloat(e.price_huf)||0;switch(t){case"USD":return e.price_usd&&parseFloat(e.price_usd)>0?parseFloat(e.price_usd):this.convertFromHuf(r,"USD");case"EUR":return e.price_eur&&parseFloat(e.price_eur)>0?parseFloat(e.price_eur):this.convertFromHuf(r,"EUR");default:return r}}getDiscountedPrice(e){let t=this.getBasePrice(e),r=parseFloat(e.sale_percentage)||0;return r>0?Math.round(t*(1-r/100)*100)/100:t}getCurrencyForLanguage(e){return this.currencyMap[e]}getCurrentCurrencyCode(){return this.currentCurrency().code}getCurrentCurrencySymbol(){return this.currentCurrency().symbol}static \u0275fac=function(t){return new(t||n)};static \u0275prov=h({token:n,factory:n.\u0275fac,providedIn:"root"})};function U(n){return{id:n.id,name_hu:n.category_hu,name_en:n.category_en,name_de:n.category_de,icon:n.emoji,color:n.color,count:0}}function k(n,e="hu",t=[]){let r=parseFloat(n.price_huf)||0,i=parseInt(n.stock)||0,a=parseFloat(n.sale_percentage)||0,s=parseFloat(n.rating)||0,y=i>0,g=a>0,$=!1,q=n.featured==="1",B=g?r*(1-a/100):r,S=n.name||"",_="";switch(e){case"hu":S=n.name_hu||n.name,_=n.description_hu||"";break;case"en":S=n.name_en||n.name,_=n.description_en||"";break;case"de":S=n.name_de||n.name,_=n.description_de||"";break}let w=n.thumbnail_url||"",W=t.length>0?t.sort((F,z)=>parseInt(F.sort_id)-parseInt(z.sort_id)).map(F=>F.image_url):w?[w]:[],Q=n.category_id??n.category??"";return m(d({},n),{name:S,priceNumber:r,stockNumber:i,salePercentageNumber:a,ratingNumber:s,inStock:y,hasDiscount:g,requiresPrescription:$,isFeatured:q,price:B,discountPercentage:a,stockQuantity:i,reviewCount:0,category:Q,nameHu:n.name_hu,nameEn:n.name_en,nameDe:n.name_de,description:_,descriptionHu:n.description_hu,descriptionEn:n.description_en,descriptionDe:n.description_de,activeIngredients:n.active_ingredients,imageUrl:w,images:W,dosage:void 0})}var H=class n{API_URL=j.baseURL;http=u(I);translationService=u(f);allProductsSignal=o([]);rawProducts=o([]);featuredSignal=o([]);categoriesSignal=o([]);loadingSignal=o(!1);errorSignal=o(null);filtersSignal=o({categories:[],priceRange:null,inStockOnly:!1,sortBy:"popularity"});currentPageSignal=o(1);itemsPerPageSignal=o(30);products=c(()=>this.allProductsSignal());featuredProducts=c(()=>this.featuredSignal());categories=c(()=>this.categoriesSignal());currentFilters=c(()=>this.filtersSignal());isLoading=c(()=>this.loadingSignal());error=c(()=>this.errorSignal());filteredProducts=c(()=>{let e=this.allProductsSignal(),t=this.filtersSignal();if(t.categories&&t.categories.length>0&&(e=e.filter(r=>t.categories.includes(r.category))),t.priceRange){let{min:r,max:i}=t.priceRange;e=e.filter(a=>a.price>=r&&a.price<=i)}return t.inStockOnly&&(e=e.filter(r=>r.inStock)),t.sortBy&&(e=this.sortProducts(e,t.sortBy)),e});paginationState=c(()=>{let e=this.filteredProducts().length,t=this.itemsPerPageSignal(),r=this.currentPageSignal(),i=Math.ceil(e/t);return{currentPage:r,itemsPerPage:t,totalItems:e,totalPages:i}});paginatedProducts=c(()=>{let e=this.filteredProducts(),t=this.currentPageSignal(),r=this.itemsPerPageSignal(),i=(t-1)*r;return e.slice(i,i+r)});loadProducts(){return v(this,null,function*(){this.loadingSignal.set(!0),this.errorSignal.set(null);try{let e=yield P(this.getAllProducts()),t=this.translationService.getCurrentLanguage(),r=this.buildCategoryIdMap(),i=e.map(s=>this.normalizeCategoryId(s,r)),a=i.map(s=>k(s,t));this.rawProducts.set(i),this.allProductsSignal.set(a),this.updateCategoryCounts(),console.log(`Loaded ${e.length} products from backend`)}catch(e){console.error("Failed to load products from backend:",e),this.errorSignal.set("products.error.load_failed"),this.allProductsSignal.set([]),this.rawProducts.set([])}finally{this.loadingSignal.set(!1)}})}loadFeaturedProducts(){return v(this,null,function*(){try{let e=yield P(this.getFeaturedFromApi()),t=this.translationService.getCurrentLanguage(),r=this.buildCategoryIdMap(),a=e.map(s=>this.normalizeCategoryId(s,r)).map(s=>k(s,t));this.featuredSignal.set(a),console.log(`Loaded ${e.length} featured products from backend`)}catch(e){let t=this.allProductsSignal().filter(r=>r.isFeatured);this.featuredSignal.set(t),console.warn("Featured products endpoint unavailable, using loaded products as fallback:",e)}})}loadCategories(){return v(this,null,function*(){try{let e=yield P(this.getAllCategories()),t=e.map(U);this.categoriesSignal.set(t),this.updateCategoryCounts(),console.log(`Loaded ${e.length} categories from backend`)}catch(e){console.error("Failed to load categories from backend:",e),this.categoriesSignal.set([])}})}setFilters(e){this.filtersSignal.update(t=>d(d({},t),e)),this.currentPageSignal.set(1)}clearFilters(){this.filtersSignal.set({categories:[],priceRange:null,inStockOnly:!1,sortBy:"popularity"}),this.currentPageSignal.set(1)}setPage(e){let t=this.paginationState().totalPages;e>=1&&e<=t&&this.currentPageSignal.set(e)}setItemsPerPage(e){this.itemsPerPageSignal.set(e),this.currentPageSignal.set(1)}getAllProducts(){return this.http.get(`${this.API_URL}/api/get_all_products`).pipe(C(5e3),l(e=>{if(e.statuscode!=="200")throw new Error(`API Error: ${e.status}`);if(!Array.isArray(e.products))throw new Error("Invalid products response");return e.products}),p(this.handleError))}getAllCategories(){return this.http.get(`${this.API_URL}/api/get_all_product_categories`).pipe(C(5e3),l(e=>{if(e.statuscode!=="200")throw new Error(`API Error: ${e.status}`);if(!Array.isArray(e.product_categories))throw new Error("Invalid categories response");return e.product_categories}),p(this.handleError))}getFeaturedFromApi(){return this.http.get(`${this.API_URL}/api/get_all_featured_products`).pipe(C(5e3),l(e=>{if(e.statuscode!=="200")throw new Error(`API Error: ${e.status}`);if(!Array.isArray(e.products))throw new Error("Invalid featured response");return e.products}),p(this.handleError))}getProductById(e){return this.getAllProducts().pipe(l(t=>t.find(r=>r.id===e)),p(()=>b(void 0)))}getProductsByCategory(e){return this.getAllProducts().pipe(l(t=>t.filter(r=>(r.category??r.category_id)===e)),p(()=>b([])))}getInStockProducts(){return this.getAllProducts().pipe(l(e=>e.filter(t=>parseInt(t.stock)>0)),p(()=>b([])))}searchProducts(e){let t=e.toLowerCase();return this.getAllProducts().pipe(l(r=>r.filter(i=>i.name_en.toLowerCase().includes(t)||i.name_hu.toLowerCase().includes(t)||i.name_de.toLowerCase().includes(t))),p(()=>b([])))}getSaleProducts(){return this.getAllProducts().pipe(l(e=>e.filter(t=>parseFloat(t.sale_percentage)>0)),p(()=>b([])))}buildCategoryIdMap(){let e=new Map;return this.categoriesSignal().forEach(t=>{e.set(t.id,t.id)}),e}updateCategoryCounts(){let e=this.allProductsSignal(),t=this.categoriesSignal();if(t.length===0)return;let r=new Map;e.forEach(a=>{let s=a.category_id??a.category??"";s&&r.set(s,(r.get(s)??0)+1)});let i=t.map(a=>m(d({},a),{count:r.get(a.id)??0}));this.categoriesSignal.set(i)}getCategoryById(e){return this.categoriesSignal().find(t=>t.id===e)}normalizeCategoryId(e,t){let r=e.category??e.category_id??"";return m(d({},e),{category:r})}sortProducts(e,t){let r=[...e];switch(t){case"popularity":return r.sort((i,a)=>parseFloat(a.times_ordered)-parseFloat(i.times_ordered));case"price-asc":return r.sort((i,a)=>i.price-a.price);case"price-desc":return r.sort((i,a)=>a.price-i.price);case"name-asc":return r.sort((i,a)=>i.name.localeCompare(a.name));case"name-desc":return r.sort((i,a)=>a.name.localeCompare(i.name));case"rating":case"rating-desc":return r.sort((i,a)=>a.ratingNumber-i.ratingNumber);case"newest":return r.sort((i,a)=>new Date(a.created_at).getTime()-new Date(i.created_at).getTime());default:return r}}handleError(e){let t="An unknown error occurred";return e.error instanceof ErrorEvent?t=e.error.message:t={400:"Bad request",404:"Not found",500:"Server error"}[e.status]??`Error ${e.status}: ${e.message}`,console.error("ProductService Error:",t),R(()=>new Error(t))}static \u0275fac=function(t){return new(t||n)};static \u0275prov=h({token:n,factory:n.\u0275fac,providedIn:"root"})};var T=class n{translationService=u(f);currencyService=u(D);cartItems=o([]);items=this.cartItems.asReadonly();itemCount=c(()=>this.cartItems().reduce((e,t)=>e+t.quantity,0));totalPrice=c(()=>this.cartItems().reduce((e,t)=>e+this.getItemTotal(t.product,t.quantity),0));constructor(){this.loadCartFromStorage()}getProductPrice(e){return this.currencyService.getBasePrice(e)}getProductFinalPrice(e){return this.currencyService.getDiscountedPrice(e)}getItemTotal(e,t){return this.currencyService.getDiscountedPrice(e)*t}formatPrice(e){return this.currencyService.formatPrice(e)}getFormattedUnitPrice(e){return this.currencyService.formatPrice(this.currencyService.getDiscountedPrice(e))}getFormattedItemTotal(e,t){return this.currencyService.formatPrice(this.getItemTotal(e,t))}getProductName(e){switch(this.translationService.getCurrentLanguage()){case"hu":return e.name_hu;case"en":return e.name_en;case"de":return e.name_de;default:return e.name_en}}getProductDescription(e,t=!1){let r=this.translationService.getCurrentLanguage();if(t)switch(r){case"hu":return e.description_preview_hu;case"en":return e.description_preview_en;case"de":return e.description_preview_de;default:return e.description_preview_en}switch(r){case"hu":return e.description_hu;case"en":return e.description_en;case"de":return e.description_de;default:return e.description_en}}addToCart(e,t=1,r=!0){let i=this.cartItems().find(a=>a.product.id===e.id);if(i){let a=r?i.quantity+t:t;this.updateQuantity(e.id,a)}else this.cartItems.update(a=>[...a,{product:e,quantity:t}]),this.saveCartToStorage()}removeFromCart(e){this.cartItems.update(t=>t.filter(r=>r.product.id!==e)),this.saveCartToStorage()}updateQuantity(e,t){if(t<=0){this.removeFromCart(e);return}this.cartItems.update(r=>r.map(i=>{if(i.product.id===e){let a=parseFloat(i.product.stock)||0;return m(d({},i),{quantity:Math.min(t,a)})}return i})),this.saveCartToStorage()}clearCart(){this.cartItems.set([]),this.saveCartToStorage()}isInCart(e){return this.cartItems().some(t=>t.product.id===e)}getItemQuantity(e){return this.cartItems().find(r=>r.product.id===e)?.quantity??0}saveCartToStorage(){try{localStorage.setItem("cart",JSON.stringify(this.cartItems()))}catch(e){console.error("Failed to save cart to localStorage:",e)}}loadCartFromStorage(){try{let e=localStorage.getItem("cart");if(e){let t=JSON.parse(e);this.cartItems.set(t)}}catch(e){console.error("Failed to load cart from localStorage:",e)}}static \u0275fac=function(t){return new(t||n)};static \u0275prov=h({token:n,factory:n.\u0275fac,providedIn:"root"})};export{f as a,D as b,H as c,T as d};
