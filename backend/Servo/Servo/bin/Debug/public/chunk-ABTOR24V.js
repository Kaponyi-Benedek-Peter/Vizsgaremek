import{b,g as k,q as f}from"./chunk-MXNZA3P6.js";import{J as g,N as c,Ob as h,R as S,S as E,h as _,ja as d,l as v,y as a}from"./chunk-766VLGYE.js";var p=class o{toasts=d([]);toasts$=this.toasts.asReadonly();show(e,t="info",s=3e3){let r=Math.random().toString(36).substring(7),i={id:r,message:e,type:t,duration:s};this.toasts.update(l=>[...l,i]),s>0&&setTimeout(()=>{this.remove(r)},s)}success(e,t){this.show(e,"success",t)}error(e,t){this.show(e,"error",t)}info(e,t){this.show(e,"info",t)}warning(e,t){this.show(e,"warning",t)}remove(e){this.toasts.update(t=>t.filter(s=>s.id!==e))}clear(){this.toasts.set([])}static \u0275fac=function(t){return new(t||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var R=class o{constructor(e,t){this.http=e;this.router=t;this.initAuth(),this.setupStorageListener()}API_URL=f.baseURL;TOKEN_KEY="auth_token";USER_KEY="auth_user";EXPIRES_KEY="auth_expires";STORAGE_TYPE_KEY="auth_storage_type";SESSION_TOKEN_KEY="auth_session_token";toastService=E(p);authStateSignal=d({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null});authState=this.authStateSignal.asReadonly();isAuthenticated=h(()=>this.authStateSignal().isAuthenticated);currentUser=h(()=>this.authStateSignal().user);token=h(()=>this.authStateSignal().token);sessionToken=h(()=>this.authStateSignal().sessionToken);authStateSubject=new _({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null});authState$=this.authStateSubject.asObservable();initAuth(){let e=this.getStoredToken(),t=this.getStoredUser(),s=this.getStoredExpiration(),r=this.getStoredSessionToken();e&&t&&s&&(new Date<s?this.updateAuthState({isAuthenticated:!0,user:t,token:e,sessionToken:r,expiresAt:s}):this.clearStorage())}setupStorageListener(){typeof window<"u"&&window.addEventListener("storage",e=>{e.key===this.TOKEN_KEY&&e.newValue===null&&(this.updateAuthState({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null}),this.router.url.includes("/login")||this.router.navigate(["/login"],{queryParams:{}})),e.key===this.TOKEN_KEY&&e.newValue!==null&&this.initAuth()})}isTokenExpired(){let e=this.authStateSignal().expiresAt;if(!e)return!0;let t=new Date,s=new Date(e),r=300*1e3;return t.getTime()>=s.getTime()-r}loginRequest(e,t){let s={email:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/login_request`,s).pipe(a(this.handleError.bind(this)))}loginPromise(e,t,s){let r={id:e,confirmation_token:t};return this.http.post(`${this.API_URL}/api/login_promise`,r).pipe(g(i=>{this.handleLoginSuccess(i,s)}),a(this.handleError.bind(this)))}register(e,t,s,r){let i={email:this.encodeBase64(e),password:this.encodeBase64(t),firstname:this.encodeBase64(s),lastname:this.encodeBase64(r)};return this.http.post(`${this.API_URL}/api/registration_request`,i).pipe(a(this.handleError.bind(this)))}completeRegistration(e,t,s=!0){let r={id:e,token:t};return this.http.post(`${this.API_URL}/api/registration_promise`,r).pipe(g(i=>{this.handleLoginSuccess(i,s,i.user,!0)}),a(this.handleError.bind(this)))}requestPasswordChange(e,t){let s={email:this.encodeBase64(e),password:this.encodeBase64(t)};return this.http.post(`${this.API_URL}/api/chpass_request`,s).pipe(a(this.handleError.bind(this)))}completePasswordChange(e,t){let s={id:e,token:t};return this.http.post(`${this.API_URL}/api/chpass_promise`,s).pipe(a(this.handleError.bind(this)))}logout(){this.clearStorage(),this.updateAuthState({isAuthenticated:!1,user:null,token:null,sessionToken:null,expiresAt:null}),this.router.navigate(["/login"])}getToken(){let e=this.authStateSignal().token;return e&&this.isTokenExpired()?(this.logout(),null):e}getSessionToken(){return this.authStateSignal().sessionToken}isUserAuthenticated(){let e=this.authStateSignal().isAuthenticated,t=this.getToken()!==null;return e&&t}refreshAuthState(){this.initAuth()}hasStoredSession(){return this.getStoredToken()!==null}decodeJWT(e){try{let s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(s).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return console.error("JWT decode error:",t),null}}handleLoginSuccess(e,t,s,r=!1){let i=e.jwt_token,l=e.session_token??null,m=e.jwt_token_expiration?new Date(e.jwt_token_expiration):new Date(Date.now()+10080*60*1e3),u=s;if(!u&&i){let n=this.decodeJWT(i);n&&(u={id:n.sub||n["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"],email:n.email||n["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"],firstname:n.firstname||"",lastname:n.lastname||""})}this.clearStorage(),this.storeToken(i,m,t),this.storeSessionToken(l,t),u&&this.storeUser(u,t),this.updateAuthState({isAuthenticated:!0,user:u||this.getStoredUser(),token:i,sessionToken:l,expiresAt:m}),r||(this.router.navigate(["/home"],{queryParams:{}}),setTimeout(()=>{this.toastService.success("auth.success.welcome_back")},300))}updateAuthState(e){this.authStateSignal.set(e),this.authStateSubject.next(e)}storeToken(e,t,s){let r=s?localStorage:sessionStorage;r.setItem(this.TOKEN_KEY,e),r.setItem(this.EXPIRES_KEY,t.toISOString()),r.setItem(this.STORAGE_TYPE_KEY,s?"local":"session")}storeSessionToken(e,t){if(!e)return;(t?localStorage:sessionStorage).setItem(this.SESSION_TOKEN_KEY,e)}storeUser(e,t){(t?localStorage:sessionStorage).setItem(this.USER_KEY,JSON.stringify(e))}getStoredToken(){return localStorage.getItem(this.TOKEN_KEY)||sessionStorage.getItem(this.TOKEN_KEY)}getStoredSessionToken(){return localStorage.getItem(this.SESSION_TOKEN_KEY)||sessionStorage.getItem(this.SESSION_TOKEN_KEY)}getStoredUser(){let e=localStorage.getItem(this.USER_KEY)||sessionStorage.getItem(this.USER_KEY);if(!e)return null;try{return JSON.parse(e)}catch{return null}}getStoredExpiration(){let e=localStorage.getItem(this.EXPIRES_KEY)||sessionStorage.getItem(this.EXPIRES_KEY);if(!e)return null;try{return new Date(e)}catch{return null}}clearStorage(){[localStorage,sessionStorage].forEach(e=>{e.removeItem(this.TOKEN_KEY),e.removeItem(this.USER_KEY),e.removeItem(this.EXPIRES_KEY),e.removeItem(this.STORAGE_TYPE_KEY),e.removeItem(this.SESSION_TOKEN_KEY)})}encodeBase64(e){try{return btoa(unescape(encodeURIComponent(e)))}catch{return btoa(e)}}handleError(e){let t="auth.errors.unknown_error";if(e.error instanceof ErrorEvent)t="auth.errors.network_error";else{let r=e.error?.status;switch(r){case"inexistent_user_or_incorrect_data":t="auth.errors.invalid_credentials_or_inexistent_user";break;case"user_not_found":t="auth.errors.invalid_credentials";break;case"user_already_exists":t="auth.errors.email_exists";break;case"user_already_activated":t="auth.errors.already_activated";break;case"wrong_token":case"wrong_confirmation_token":t="auth.errors.invalid_token";break;case"confirmation_expired":t="auth.errors.token_expired";break;case"user_banned":t="auth.errors.account_banned";break;case"malformed_request":t="auth.errors.bad_request";break;case"internal_error":t="auth.errors.server_error";break;default:switch(e.status){case 0:t="auth.errors.network_error";break;case 400:t="auth.errors.bad_request";break;case 401:t="auth.errors.invalid_credentials";break;case 403:t="auth.errors.invalid_credentials__or_inexistent_user";break;case 404:t="auth.errors.not_found";break;case 409:t="auth.errors.email_exists";break;case 500:t="auth.errors.server_error";break}}(r==="hianyzo_auth_header"||r==="hibas_token")&&this.logout()}return v(()=>new Error(t))}static \u0275fac=function(t){return new(t||o)(S(b),S(k))};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a,R as b};
